#!/bin/bash
#BBTools version 38.44
#The steps below recapitulate the output of RQCFilter2 when run like this:
#rqcfilter2.sh jni=t in=rqcfilter.input.fastq.gz path=filter rna=f trimfragadapter=t qtrim=r trimq=0 maxns=3 maq=3 minlen=51 mlf=0.33 phix=t removehuman=t removedog=t removecat=t removemouse=t khist=t removemicrobes=t sketch kapa=t clumpify=t tmpdir= barcodefilter=f trimpolyg=5 usejni=f rqcfilterdata=/refdata/RQCFilterData out=../rqcfilter.output.fastq.gz
#Data dependencies are available at http://portal.nersc.gov/dna/microbial/assembly/bushnell/RQCFilterData.tar


sendsketch.sh in=rqcfilter.input.fastq.gz out=filter/sketch.txt reads=2000000 name=rqcfilter.input.fastq.gz fname=rqcfilter.input.fastq.gz minprob=0.2 samplerate=1.0 merge printname0=f records=20 color=false depth depth2 unique2 unique3 volume sortbyvolume contam2=genus minprob=0.6 refhits nt translate=f sizemult=1.2 ow

sendsketch.sh in=rqcfilter.input.fastq.gz out=filter/sketch.txt reads=2000000 name=rqcfilter.input.fastq.gz fname=rqcfilter.input.fastq.gz minprob=0.2 samplerate=1.0 merge printname0=f records=20 color=false depth depth2 unique2 unique3 volume sortbyvolume contam2=genus minprob=0.6 refhits refseq translate=f sizemult=2.5 append

sendsketch.sh in=rqcfilter.input.fastq.gz out=filter/sketch.txt reads=2000000 name=rqcfilter.input.fastq.gz fname=rqcfilter.input.fastq.gz minprob=0.2 samplerate=1.0 merge printname0=f records=20 color=false depth depth2 unique2 unique3 volume sortbyvolume contam2=genus minprob=0.6 refhits silva translate=f local sizemult=1 minkeycount=2 append

sendsketch.sh in=rqcfilter.input.fastq.gz out=filter/sketch.txt reads=2000000 name=rqcfilter.input.fastq.gz fname=rqcfilter.input.fastq.gz minprob=0.2 samplerate=1.0 merge printname0=f records=20 color=false depth depth2 unique2 unique3 volume sortbyvolume contam2=genus minprob=0.6 refhits prokprot translate=t sizemult=2.2 append

bbmerge.sh overwrite=true in1=rqcfilter.input.fastq.gz outa=filter/adaptersDetected.fa reads=1m

clumpify.sh pigz=t unpigz=t zl=4 reorder in1=rqcfilter.input.fastq.gz out1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_CLUMP_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz passes=1

bbduk.sh ktrim=r ordered minlen=51 minlenfraction=0.33 mink=11 tbo tpe rcomp=f overwrite=true k=23 hdist=1 hdist2=1 ftm=5 pratio=G,C plen=20 phist=filter/phist.txt qhist=filter/qhist.txt bhist=filter/bhist.txt gchist=filter/gchist.txt pigz=t unpigz=t zl=4 ow=true in1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_CLUMP_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz out1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_TRIM_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz rqc=hashmap outduk=filter/ktrim_kmerStats1.txt stats=filter/ktrim_scaffoldStats1.txt loglog loglogout ref=/refdata/RQCFilterData/adapters2.fa.gz

rm /cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_CLUMP_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz

seal.sh ordered overwrite=true k=31 hdist=0 pigz=t unpigz=t zl=6 in1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_TRIM_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz outu1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_SPIKEIN_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz outm=filter/spikein.fq.gz stats=filter/scaffoldStatsSpikein.txt loglog loglogout ref=/refdata/RQCFilterData/kapatags.L40.fa.gz

rm /cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_TRIM_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz

bbduk.sh maq=3.0,0 trimq=0.0 qtrim=r ordered overwrite=true maxns=3 minlen=51 minlenfraction=0.33 k=31 hdist=1 pigz=t unpigz=t zl=6 cf=t barcodefilter=f ow=true in1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_SPIKEIN_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz out1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_FILTER1_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz outm=filter/synth1.fq.gz rqc=hashmap outduk=filter/kmerStats1.txt stats=filter/scaffoldStats1.txt trimpolygleft=5 trimpolygright=5 loglog loglogout ref=/refdata/RQCFilterData/Illumina.artifacts.fa.gz,/refdata/RQCFilterData/nextera_LMP_linker.fa.gz,/refdata/RQCFilterData/phix174_ill.ref.fa.gz,/refdata/RQCFilterData/lambda.fa.gz,/refdata/RQCFilterData/pJET1.2.fa.gz

rm /cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_SPIKEIN_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz

bbduk.sh ordered overwrite=true k=20 hdist=1 pigz=t unpigz=t zl=6 ow=true in1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_FILTER1_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz out1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_FILTER2_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz outm=filter/synth2.fq.gz outduk=filter/kmerStats2.txt stats=filter/scaffoldStats2.txt loglog loglogout ref=/refdata/RQCFilterData/short.fa.gz,/refdata/RQCFilterData/short.fa.gz

rm /cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_FILTER1_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz

bbmap.sh ordered quickmatch k=13 idtag=t printunmappedcount ow=true qtrim=rl trimq=10 untrim null path=/refdata/RQCFilterData/commonMicrobes/ pigz=t unpigz=t zl=6 minid=.95 idfilter=.95 maxindel=3 minhits=2 bw=12 bwr=0.16 null maxsites2=10 build=1 tipsearch=0 in1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_FILTER2_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz outu1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_MICROBE_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz outm=filter/microbes.fq.gz scafstats=filter/commonMicrobes.txt

rm /cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_FILTER2_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz

bbsplit.sh ordered=false k=14 idtag=t usemodulo printunmappedcount ow=true qtrim=rl trimq=10 untrim kfilter=25 maxsites=1 tipsearch=0 minratio=.9 maxindel=3 minhits=2 bw=12 bwr=0.16 fast=true maxsites2=10 build=1 ef=0.03 outm=filter/human.fq.gz path=/refdata/RQCFilterData/mousecatdoghuman/ refstats=filter/refStats.txt pigz=t unpigz=t zl=9 forcereadonly in1=/cromwell-executions/metagenome_filtering_assembly_and_alignment/9617fcc1-b903-449c-9245-c0438074d3ea/call-filter/rqcfilter2.rqcfilter2/b6a3d4bd-ce8a-492b-9b45-7c984a7fbc60/call-rqcfilter/tmp.78844a64/TEMP_MICROBE_59eaf509b9f29d0645fe86d03f2af_rqcfilter.output.fastq.gz outu1=filter/../rqcfilter.output.fastq.gz

bbmerge.sh loose overwrite=true in1=filter/../rqcfilter.output.fastq.gz ihist=filter/ihist_merge.txt outc=filter/cardinality.txt pigz=t unpigz=t zl=9 adapters=/refdata/RQCFilterData/adapters2.fa.gz mininsert=25 ecct extend2=100 rem k=62 prefilter prealloc loglog

kmercountexact.sh overwrite=true in1=filter/../rqcfilter.output.fastq.gz khist=filter/khist.txt peaks=filter/peaks.txt unpigz=t gchist
